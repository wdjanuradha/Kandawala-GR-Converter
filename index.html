<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Kandawala GR Converter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      font-family: 'Consolas', monospace;
      background-color: #0a0f0d;
      color: #00ff99;
      margin: 0;
      padding: 0;
    }
    header {
      background: #111;
      padding: 1rem;
      text-align: center;
      border-bottom: 2px solid #00ff99;
    }
    .container {
      padding: 1rem;
      max-width: 800px;
      margin: auto;
    }
    input, button {
      padding: 0.5rem;
      font-size: 1rem;
      margin: 0.2rem;
      border-radius: 6px;
      border: 1px solid #00ff99;
      background: #111;
      color: #00ff99;
    }
    button:hover {
      background: #00ff99;
      color: #111;
      cursor: pointer;
    }
    #map {
      height: 400px;
      margin-top: 1rem;
      border: 2px solid #00ff99;
      border-radius: 8px;
    }
    .output {
      margin-top: 1rem;
      background: #111;
      padding: 1rem;
      border: 1px solid #00ff99;
      border-radius: 6px;
      white-space: pre-wrap;
    }
    a.link { color: #00ff99; }
  </style>
</head>
<body>
  <header>
    <h1>üá±üá∞ Kandawala Grid Converter</h1>
    <p>Military-Style Grid Ref ‚Üí Google Maps</p>
  </header>

  <div class="container">
    <label for="grInput">Enter 6/8 Fig GR:</label>
    <input type="text" id="grInput" placeholder="Example: 682717" value="682717" />
    <button id="convertBtn">Convert</button>

    <div class="output" id="output">Status: waiting for input...</div>
    <div id="map"></div>
  </div>

  <!-- Leaflet and Proj4 -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/proj4@2.9.1/dist/proj4.js"></script>

  <script>
    window.addEventListener('load', function () {
      const out = document.getElementById('output');

      if (typeof L === 'undefined') {
        out.textContent = 'Error: Leaflet is not loaded.';
        return;
      }

      if (typeof proj4 === 'undefined') {
        out.textContent = 'Error: proj4 is not loaded.';
        return;
      }

      // Define EPSG:5234 exactly per WKT (Everest 1830, Kandawala Datum)
      proj4.defs("EPSG:5234", "+proj=tmerc +lat_0=7.00048027777778 +lon_0=80.7717111111111 +k=0.9999238418 +x_0=200000 +y_0=200000 +a=6377276.345 +rf=300.8017 +towgs84=-97,787,86,0,0,0,0 +units=m +no_defs");

      // Map setup
      const map = L.map('map').setView([7.8731, 80.7718], 7);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
      let marker = null;

      function convertGR() {
        const gr = (document.getElementById('grInput').value || '').trim();

        if (!/^\d{6,8}$/.test(gr)) {
          alert('Enter a valid 6 or 8 digit grid reference (e.g., 682717 or 68227177)');
          return;
        }

        let easting, northing;
        if (gr.length === 6) {
          easting = parseInt(gr.slice(0, 3)) * 100;
          northing = parseInt(gr.slice(3, 6)) * 100;
        } else {
          easting = parseInt(gr.slice(0, 4)) * 10;
          northing = parseInt(gr.slice(4, 8)) * 10;
        }

        // Add grid band offsets ‚Äî default used in Sri Lankan mapping conventions
        const fullE = 100000 + easting;
        const fullN = 300000 + northing;

        try {
          const [lon, lat] = proj4('EPSG:5234', 'WGS84', [fullE, fullN]);
          const latLon = {
            lat: +lat.toFixed(6),
            lon: +lon.toFixed(6)
          };

          out.innerHTML = `üìç Grid Reference: ${gr}
Easting: ${fullE}
Northing: ${fullN}
Latitude: ${latLon.lat}
Longitude: ${latLon.lon}
üîó <a class="link" target="_blank" href="https://www.google.com/maps?q=${latLon.lat},${latLon.lon}">Open in Google Maps</a>`;

          if (marker) map.removeLayer(marker);
          marker = L.marker([latLon.lat, latLon.lon]).addTo(map).bindPopup('GR: ' + gr).openPopup();
          map.setView([latLon.lat, latLon.lon], 14);
        } catch (err) {
          out.textContent = 'Conversion failed: ' + err.message;
        }
      }

      document.getElementById('convertBtn').addEventListener('click', convertGR);
      out.textContent = 'Ready. Enter a 6 or 8 digit grid reference and press Convert.';
    });
  </script>
</body>
</html>
