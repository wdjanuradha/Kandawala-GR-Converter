<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Kandawala GR Converter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Leaflet CSS from a reliable CDN -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      font-family: 'Consolas', monospace;
      background-color: #0a0f0d;
      color: #00ff99;
      margin: 0;
      padding: 0;
    }
    header {
      background: #111;
      padding: 1rem;
      text-align: center;
      border-bottom: 2px solid #00ff99;
    }
    .container {
      padding: 1rem;
      max-width: 800px;
      margin: auto;
    }
    input, button {
      padding: 0.5rem;
      font-size: 1rem;
      margin: 0.2rem;
      border-radius: 6px;
      border: 1px solid #00ff99;
      background: #111;
      color: #00ff99;
    }
    button:hover {
      background: #00ff99;
      color: #111;
      cursor: pointer;
    }
    #map {
      height: 400px;
      margin-top: 1rem;
      border: 2px solid #00ff99;
      border-radius: 8px;
    }
    .output {
      margin-top: 1rem;
      background: #111;
      padding: 1rem;
      border: 1px solid #00ff99;
      border-radius: 6px;
      white-space: pre-wrap;
    }
    a.link{ color: #00ff99 }
  </style>
</head>
<body>
  <header>
    <h1>ðŸ‡±ðŸ‡° Kandawala Grid Converter</h1>
    <p>Military-Style GR â†’ Google Maps</p>
  </header>

  <div class="container">
    <label>Enter 6/8 Fig GR:</label>
    <input type="text" id="grInput" placeholder="Example: 682717" value="682717">
    <button id="convertBtn">Convert</button>

    <div class="output" id="output">Status: waiting for input...</div>

    <div id="map"></div>
  </div>

  <!-- Load Leaflet and proj4 from reliable CDNs BEFORE running the script below -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/proj4@2.8.1/dist/proj4.js"></script>

  <script>
    // Wrap initialization so we only run after window load and after proj4 & Leaflet are available
    window.addEventListener('load', function () {
      const out = document.getElementById('output');

      // Safety check: proj4 must be available. If not, try a fallback CDN dynamically.
      function ensureProj4() {
        return new Promise((resolve, reject) => {
          if (typeof proj4 !== 'undefined') return resolve();
          // fallback attempt
          const fallback = 'https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.1/proj4.js';
          const s = document.createElement('script');
          s.src = fallback;
          s.onload = () => {
            if (typeof proj4 !== 'undefined') resolve();
            else reject(new Error('proj4 loaded but global not found'));
          };
          s.onerror = () => reject(new Error('Failed to load proj4 from fallback'));
          document.head.appendChild(s);
        });
      }

      // Ensure Leaflet available
      if (typeof L === 'undefined') {
        out.textContent = 'Error: Leaflet is not loaded. Check your internet connection.';
        return;
      }

      ensureProj4().then(() => {
        // Define Kandawala projection (EPSG:5234) if not already defined
        try {
          if (!proj4.defs['EPSG:5234']) {
            proj4.defs('EPSG:5234', "+proj=tmerc +lat_0=7 +lon_0=80.77171333333333 +k=0.9999238418 +x_0=200000 +y_0=200000 +a=6377276.345 +rf=300.8017 +towgs84=-97,787,86 +units=m +no_defs");
          }
        } catch (err) {
          out.textContent = 'Projection definition failed: ' + err;
          return;
        }

        // Initialize Leaflet map
        const map = L.map('map').setView([7.8731, 80.7718], 7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
        let marker = null;

        // Conversion function (keeps same behaviour as before)
        function convertGR() {
          const grEl = document.getElementById('grInput');
          const gr = (grEl.value || '').trim();
          if (!/^[0-9]{6,8}$/.test(gr)) {
            alert('Enter a valid 6 or 8 figure Grid Reference');
            return;
          }

          let easting, northing;
          if (gr.length === 6) {
            easting = parseInt(gr.substring(0, 3), 10) * 100; // 100 m precision
            northing = parseInt(gr.substring(3, 6), 10) * 100;
          } else {
            easting = parseInt(gr.substring(0, 4), 10) * 10; // 10 m precision
            northing = parseInt(gr.substring(4, 8), 10) * 10;
          }

          // NOTE: This UI preserves the previous behavior: add 100000 to Easting and 300000 to Northing.
          // If you want automatic candidate bands (1xx / 2xx) or smarter logic, I can add that.
          const fullE = 100000 + easting;
          const fullN = 300000 + northing;

          let latLon;
          try {
            // proj4 expects [E, N] -> returns [lon, lat]
            const outCoord = proj4('EPSG:5234', 'WGS84', [fullE, fullN]);
            latLon = { lat: +outCoord[1].toFixed(6), lon: +outCoord[0].toFixed(6) };
          } catch (err) {
            out.textContent = 'Coordinate conversion failed: ' + err;
            return;
          }

          out.innerHTML = `GR: ${gr}\nEasting: ${fullE}\nNorthing: ${fullN}\nLat: ${latLon.lat}\nLon: ${latLon.lon}\n` +
            `<a class="link" target="_blank" href="https://www.google.com/maps?q=${latLon.lat},${latLon.lon}">Open in Google Maps</a>`;

          if (marker) map.removeLayer(marker);
          marker = L.marker([latLon.lat, latLon.lon]).addTo(map).bindPopup('GR: ' + gr).openPopup();
          map.setView([latLon.lat, latLon.lon], 14);
        }

        // Attach event
        document.getElementById('convertBtn').addEventListener('click', convertGR);

        out.textContent = 'Ready. Enter a 6/8 digit GR and press Convert.';

      }).catch((err) => {
        out.textContent = 'Failed to load proj4 library: ' + err.message + '\nPlease check your internet connection or allow loading external scripts.';
      });
    });
  </script>
</body>
</html>
